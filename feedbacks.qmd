---
title: "Feedbacks"
format:
  html:
    toc: true
    html-math-method: katex
    css: styles.css
    code-fold: true
    code-summary: "Show the code"
editor: visual
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

**Here we analyse how participants named presented figures and what kind of struggles their experienced. Also, their feedback on some issues presented**


## Setup

```{r, message= FALSE, warning=FALSE, echo=FALSE}
# upload to the git
library(readxl)
library(foreach)
library(stringr)
library(dplyr)
library(tidyr)
library(tokenizers)
library(data.table)
library(ggplot2)
library(purrr)
library(tidytext)
library(kableExtra)
library(stringi)
library(magick)
library(gt)
```

```{r, message= FALSE, warning=FALSE}
data <- read_excel("data/results_survey.xlsx")
data <- data[1:121] %>% 
  filter(.[[18]] !='Yes') # not analysed any EEG method

```

### word_preproc

```{r, message= FALSE, warning=FALSE}
word_preproc <- function(data, N){
 # N = 69
  stop_list = c("a", "an", "the", "wise", "like", "s", "plot", "plots")
  tmp <- data %>% filter(!is.na(.[[N]])) %>% select(., N) %>% 
    dplyr::rename(words = !!names(.)[1]) %>% mutate(words = tolower(words)) %>% 
    mutate(words_prep = str_split(words, "\\s+")) %>%
    mutate(words_prep = sapply(words_prep, function(x) paste(x[!x %in% stop_list], collapse = " "))) %>% 
    mutate(words_prep = stri_replace_all_regex(words_prep,
                                  pattern=c(" \\(.*", ", or.*", " across.*", " with.*", " at.*", " by.*", " over.*", #" of.*", 
                                            " for.*", " per.*", " across.*", " accross.*", " between.*"),
                                  replacement=c(''),
                                  vectorize=FALSE)) %>% 
    mutate(words_prep = str_split(words_prep, "\\s+")) %>%
    mutate(words_prep = sapply(words_prep, function(x) paste(x[!x %in% stop_list], collapse = " ")))
     
  return(tmp)
}

```

## Plot dimension


```{r}
### miniatures
# mins <- image_read_pdf("data/eegvis_icons.pdf", density = 1000)  
# for (i in 1:8){
#   image_write(mins[i], path = paste0("img/", i, ".png"), format = "png", density = 1000)
# }

```

### dimensions

```{r}
dm <- data.frame()

  
data.frame(plots = c("ERP plot", "Butterfly plot", "Topoplot", "Topoplot timeseries", "ERP grid", "ERP image", "Channel image", "Parallel plot"), 
           time = c("x", "x", "", "(x)", "x", "x", "x", "x"),
           channels = c("", "x", "x", "x", "x", "", "x", "x"), 
           spatial = c("", "", "x", "x", "x", "", "", ""), 
           conditions = c("x", "", "", "", "", "", "", "x"), 
           trials = c("", "x", "", "", "", "x", "", "")) %>% kable(align="lcccccc")  %>% 
  kable_minimal(full_width = F,  html_font = "Source Sans Pro") 

```

```{r}
#im_vector <- c("img/1.png", "img/2.png", "img/3.png", "img/4.png", "img/5.png", "img/6.png", "img/7.png", "img/8.png")

cm <- dplyr::tibble(
  Plots = c("img/1.png", "img/2.png", "img/3.png", "img/4.png", "img/5.png", "img/6.png", "img/7.png", "img/8.png"),
  Name = c("ERP plot", "Butterfly plot", "Topoplot", "Topoplot timeseries", "ERP grid", "ERP image", "Channel image", "Parallel plot"), 
  Time = c("x", "x", "", "(x)", "x", "x", "x", "x"),
  Channels = c("", "x", "x", "x", "x", "", "x", "x"), 
  Spatial = c("", "", "x", "x", "x", "", "", ""), 
  Conditions = c("x", "", "", "", "", "", "", "x"), 
  Trials = c("", "x", "", "", "", "x", "", "")
) 

cm %>% 
  gt()  %>% 
  cols_align(align = "center", columns = c(Time, Channels, Spatial, Conditions, Trials)) %>% 
  cols_width(
    Time ~ px(50),
    Channels ~ px(50),
    Spatial ~ px(50),
    Conditions ~ px(50),
    Trials ~ px(50),
  ) %>% 
  text_transform(
    locations = cells_body(columns = Plots),
    fn = function(x) {
      lapply(x, function(x) {
              html(paste(local_image(filename = x)))
      })
    }
  ) %>%  opt_table_font(font = "Source Sans Pro")  #,stack = "rounded-sans") 
 
```


## The most common names for each plot

#### 1

```{r}
n1 <- word_preproc(data, 69)  %>% #View()
   mutate(type = case_when(
      grepl("\\b(idea|sure|confus|aware|do not|know|why|remember)\\b", words) == TRUE ~ "bad", 
      grepl("\\b(average(d)?|averagded)\\b.*\\b(erp(s)?|ep|related)\\b|\\b(erp(s)?|ep|related)\\b.*\\baverage(d)?\\b", words) == TRUE ~ "averaged erp (plot)",
      grepl("\\bwave(form|forms)?\\b.*\\b(erp(s)?|ep|related)\\b|\\b(erp(s)?|ep|related)\\b.*\\bwave(form|forms)?\\b", words) == TRUE ~ "erp wave(form)s",
      grepl("\\btime(course|series|domain)?\\b.*\\b(erp(s)?|ep|related)\\b|\\b(erp(s)?|ep|related)\\b.*\\btime(course|series|domain)?\\b", words) == TRUE ~ "erp timecourse/timeseries",
      grepl("\\b(classic(al)?)\\b", words) == TRUE ~ "classic erp",
      grepl("\\b(standard)\\b", words) == TRUE ~ "standart erp",
      grepl("\\b(evoked)\\b", words) == TRUE ~ "evoked potential/reponses",
      grepl("\\b(erp(s)?|ep|related)\\b", words) == TRUE ~ "erp (plot)", 
      grepl("\\b(time|timeseries)\\b", words) == TRUE ~ "time series",
  
      grepl("\\b(line|boundedline)\\b", words) == TRUE ~ "line (plot)",
      grepl("\\b(single|singleplot|singe)\\b", words) == TRUE ~ "single (channel)",
      grepl("\\b(waveform(s)?)\\b", words) == TRUE ~ "waveform",
       grepl("\\b(p300)\\b", words) == TRUE ~ "p300",
      grepl("\\b(average|mean)\\b", words) == TRUE ~ "average/mean",
      grepl("\\b(amplitude)\\b", words) == TRUE ~ "amplitude",
  
      TRUE ~ '_other'
      ))  %>%  #View()
   filter(!is.na(type), type != "bad") %>% dplyr::select(type) %>%  table(.) %>% 
  data.frame(.) %>% arrange(desc(Freq))  %>% 
   rename_at(vars(colnames(.)), ~ c("ERP plot", "n")) 
n1 
```

#### 2

```{r}
n2 <- word_preproc(data, 80)  %>%
  mutate(type = case_when(
      grepl("\\b(idea|sure|confus|aware|do not|know|why|remember|unsure|confusing|mess)\\b", words) == TRUE ~ "bad", 
      grepl("\\b(butterfly|bitterfly|buterfly|buttefly)\\b", words) == TRUE ~ "butterfly (plot)",
      grepl("\\b(spaghetti)\\b", words) == TRUE ~ "spaghetti",
      grepl("\\b(time|timeseries|timecourse)\\b", words) == TRUE ~ "time series",
      grepl("\\b(channel|single|singleplot|individual)\\b", words)  == TRUE ~ "single/individual channel erp (plot)",
      grepl("\\b(channels|multichannel|multeple|multiple|multi|all|muti|electrodes)\\b", words)  == TRUE ~ "multi(channel/electrode) erp (plot)",
      grepl("\\b(evoked)\\b", words)  == TRUE ~ "evoked responces",
      grepl("\\b(erp(s)?|eprs|event-related)\\b", words) == TRUE ~ "erp (plot)",
      TRUE ~ '_other'
      ))  %>%  #View()
  filter(!is.na(type), type != "bad") %>%
  dplyr::select(type) %>%  table(.) %>% 
  data.frame(.) %>% arrange(desc(Freq))  %>% 
   rename_at(vars(colnames(.)), ~ c("Butterfly plot", "n")) 
n2

```

#### 3

```{r}
n3 <- word_preproc(data, 85)  %>%
  mutate(type = case_when(
      grepl("\\b(idea|sure|confus|aware|do not|know|why|remember|unsure|confusing|mess)\\b", words) == TRUE ~ "bad", 
      grepl("\\b(topo|topoplot(s)?)\\b", words) == TRUE ~ "topo(plot)", 
      grepl("\\b(topomap|topomape)\\b", words) == TRUE ~ "topomap",
      grepl("\\b(topograph(y|ic|ical|ies)|topgraphy|topograbphy)\\b", words) == TRUE ~ "topography (plot)",
      grepl("\\b(heat(map)?)\\b", words) == TRUE ~ "heatmap",
      grepl("\\b(map)\\b", words) == TRUE ~ "scalp map",
      grepl("\\b(distribution)\\b", words) == TRUE ~ "scalp distribution",
      TRUE ~ '_other'
      )) %>%  #View()
  dplyr::select(type) %>%  table(.) %>% 
  data.frame(.) %>% arrange(desc(Freq))  %>% 
   rename_at(vars(colnames(.)), ~ c("Topoplot", "n")) 
n3
```

#### 4

```{r}
n4 <- word_preproc(data, 90)  %>%
  mutate(type = case_when(
      grepl("\\b(idea|sure|confus|aware|do not|know|why|remember|unsure|confusing|mess|unclear)\\b", words) == TRUE ~ "bad", 
      grepl("\\btopograph(y|ic|ical|ies)?\\b.*\\btime\\b|\\btime\\b.*\\btopograph(y|ic|ical|ies)?\\b", words) == TRUE ~ "topography over time(series/course)",
      grepl("\\btopo(plot|plots)?\\b.*\\btime(course|series|line)?\\b|\\btime(course|series|line)?\\b.*\\btopo(plot|plots)?|topology\\b", words) == TRUE ~ "topo(plot) over time(series/course)",
      grepl("\\btopo(plot|plots)?\\b.*\\btime(s)?\\b|\\btime(s)?\\b.*\\btopo(plot|plots)?|topology\\b", words) == TRUE ~ "topo(plot) over time(series/course)",
      grepl("\\btopo(plot|plots)?\\b.*\\bseries\\b|\\bseries\\b.*\\btopo(plot|plots)?\\b", words) == TRUE ~ "topo series",
      grepl("\\b(topo(s)?|topoplot(s)?)\\b", words) == TRUE ~ "topo(plot)",
      grepl("\\b(topomap(s|e)?)\\b", words) == TRUE ~ "topomap",
      grepl("\\btopograph(y|ic|ical|ies)\\b.*\\bmap(s)?\\b|\\bmap(s)?\\b.*\\btopograph(y|ic|ical|ies)\\b", words) == TRUE ~ "topographical map (over time)",
   
      grepl("\\b(topograph(y|ic|ical|ies)?|topgraphy|topograhy|topograbphy|topgraphies)\\b", words) == TRUE ~ "topography",
      grepl("\\b(heat(map)?)\\b", words) == TRUE ~ "heatmap",
      grepl("\\b(map(s)?)\\b", words) == TRUE ~ "scalp map (over time)",
      grepl("\\bscalp\\b.*\\bplot(s)?\\b|\\bplot(s)?\\b.*\\bscalp\\b", words) == TRUE ~ "scalp plot",
      grepl("\\b(distribution)\\b", words) == TRUE ~ "scalp distribution",
      TRUE ~ '_other'
      )) %>% 
  mutate(type = ifelse(nchar(words) == 1, "bad", type)) %>% 
  #View()
  dplyr::select(type) %>%  table(.) %>% 
  data.frame(.) %>% arrange(desc(Freq)) %>% filter(type != "bad")  %>% 
   rename_at(vars(colnames(.)), ~ c("Topoplot\ntimeseries", "n")) 
n4

```

#### 5

```{r}
n5 <- word_preproc(data, 97)   %>%
  mutate(type = case_when(
    grepl("\\b(idea|sure|confus|aware|do not|know|why|remember|unsure|confusing|mess|unclear|ugly|don't|useless)\\b", words) == TRUE ~ "bad",
    grepl("\\bwave(form|forms)?\\b.*\\b(erp(s)?|ep|related)\\b|\\b(erp(s)?|ep|related)\\b.*\\bwave(form|forms)?\\b", words) == TRUE ~ "erp wave(form)s",
    grepl("\\b(multi(plot|channel|ploter|ploterp)?)\\b", words) == TRUE ~ "multi(channel) plot",
    grepl("\\bchannel(s)?\\b.*\\berp(s)?\\b|\\berp(s)?\\b.*\\bchannel(s)?\\b", words) == TRUE ~ "erp over channels",
    grepl("\\btopograph(y|ic|ical|ies|logy)|topology\\b.*\\berp(s)\\b|\\berp(s)\\b.*\\btopograph(y|ic|ical|ies|logy)|topology\\b", words) == TRUE ~ "topographic erp",
    grepl("\\b(scalp)\\b", words) == TRUE ~ "(erp) scalp",
    grepl("\\b(array)\\b", words) == TRUE ~ "(erp) array",
    grepl("\\btopo(plot|plots)?\\b.*\\berp(s)?\\b|\\berp(s)?\\b.*\\btopo(plot|plots)?\\b", words) == TRUE ~ "topo erp",
    grepl("\\b(erp(s)?|eprs|event-related)\\b", words) == TRUE ~ "erp",
    grepl("\\b(topo(s)?|topoplot(s)?|toposplot)\\b", words) == TRUE ~ "topo",
    grepl("\\b(channel(s|plot)?)\\b", words) == TRUE ~ "channel (plot)",
    TRUE ~ '_other'
  )) %>%
  mutate(type = ifelse(nchar(words) == 1, "bad", type)) %>%
  mutate(type = ifelse(grepl("topographic erp", type) & !grepl("\\berp(s)?|evoked|eeg\\b", words), "topographical plot(s)", type)) %>%
 # View()
  dplyr::select(type) %>%  table(.) %>%
  data.frame(.) %>% arrange(desc(Freq)) %>% filter(type != "bad")  %>%
  rename_at(vars(colnames(.)), ~ c("ERP grid", "n"))
n5
# write.csv(n5, "topogrid.csv")
```

#### 6

```{r}
n6 <- word_preproc(data, 102)  %>% #View()
mutate(type = case_when(
  grepl("\\b(idea|sure|confus|aware|do not|know|why|good|remember|unsure|confusing|mess|\\?\\?|unclear|ugly|don't|useless)\\b", words) == TRUE ~ "bad",
  grepl("\\b(sort(ed)?)\\b", words) == TRUE ~ "sorted erp trials",
  grepl("\\bimage\\b.*\\berp(s)?\\b|\\berp(s)?\\b.*\\bimage|erpimage|image\\b", words) == TRUE ~ "erp image",
  grepl("\\bimage\\b.*\\bepoch(s)?\\b|\\bepoch(s)?\\b.*\\bimage\\b", words) == TRUE ~ "epoch image",
  grepl("\\berp(s)?\\b.*\\btrial(s)?\\b|\\btrial(s)?\\b.*\\berp(s)?\\b", words) == TRUE ~ "erp trials",
  grepl("\\b(raster(plot)?)\\b", words) == TRUE ~ "raster",
  grepl("\\b(waterfall)\\b", words) == TRUE ~ "waterfall",
  grepl("\\b(heat(map)?)\\b", words) == TRUE ~ "heatmap",
  grepl("\\b(erp(s)?|eprs|ersp|event-related)\\b", words) == TRUE ~ "erp",
  grepl("\\b(voltage)\\b", words) == TRUE ~ "voltage (over trial)",
  grepl("\\b(time(series)?|serie(s)?)\\b", words) == TRUE ~ "time series/frequencies",
  grepl("\\b(frequency|frecuencia)\\b", words) == TRUE ~ "time series/frequencies",
  grepl("\\b(trial(s|wise)?|trialplot)\\b", words) == TRUE ~ "trials",
  grepl("\\b(spectrum|spectral)\\b", words) == TRUE ~ "spectral",
  TRUE ~ '_other'
  )) %>%
  mutate(type = ifelse(nchar(words) == 1, "bad", type)) %>% # View()
  dplyr::select(type) %>%  table(.) %>%
  data.frame(.) %>% arrange(desc(Freq)) %>% filter(type != "bad")  %>%
  rename_at(vars(colnames(.)), ~ c("ERP image", "n"))
n6
#write.csv(n6, "erpimage.csv")
```

#### 7

```{r}
n7 <- word_preproc(data, 107)  %>% #View()
  mutate(type = case_when(
      grepl("\\b(idea|sure|confus|aware|do not|know|why|good|remember|unsure|confusing|mess|\\?\\?|unclear|-|ugly|don't|x|useless)\\b", words) == TRUE ~ "bad", 
      grepl("\\b(amplitude(s)?)\\b", words) == TRUE ~ "(erp) amplitudes",
      grepl("\\b(parallel)\\b", words) == TRUE ~ "parallel coordinates",
      TRUE ~ '_other'
      )) %>% #View()
  dplyr::select(type) %>%  table(.) %>% 
  data.frame(.) %>% arrange(desc(Freq)) %>% filter(type != "bad")  %>% 
   rename_at(vars(colnames(.)), ~ c("Parallel plot", "n")) 
n7
```

#### 8

```{r}
n8 <- word_preproc(data, 112)  %>%
  mutate(type = case_when(
      grepl("\\b(idea|sure|confus|aware|do not|know|why|good|remember|unsure|confusing|mess|normal|\\?\\?|unclear|recall|ugly|don't|useless|nan|clear)\\b", words) == TRUE ~ "bad", 
      grepl("\\bimage\\b.*\\bchannel\\b|\\bchannel\\b.*\\bimage|chanimage|imagesc\\b", words) == TRUE ~ "channel image",
      grepl("\\bimage\\b.*\\berp(s)?\\b|\\berp(s)?\\b.*\\bimage|erpimage\\b", words) == TRUE ~ "erp image",
      
      grepl("\\b(heat(map)?)\\b", words) == TRUE ~ "heatmap",
      grepl("\\b(image)\\b", words) == TRUE ~ "image",
      grepl("\\b(raster(plot)?|custer)\\b", words) == TRUE ~ "raster (plot)",
      grepl("\\b(matrix)\\b", words) == TRUE ~ "(erp) matrix",
      grepl("\\b(channel(s|wise)?)\\b", words) == TRUE ~ "channels (erp)",
      grepl("\\b(erp(s)?|eprs|ersp|event-related)\\b", words) == TRUE ~ "erp",
      grepl("\\b(voltage)\\b", words) == TRUE ~ "voltage",
      TRUE ~ '_other'
      )) %>%
  mutate(type = ifelse(nchar(words) == 1, "bad", type)) %>%  #View()
  dplyr::select(type) %>%  table(.) %>% 
  data.frame(.) %>% arrange(desc(Freq)) %>% filter(type != "bad") %>% 
   rename_at(vars(colnames(.)), ~ c("Channel_image", "n")) 

n8

```

### Combined

```{r}
list(n1, n2, n3, n4, n5, n6, n8) %>% kable(.) %>% kable_styling("striped", position = "center",) 
```

```{r}
plot_names <- c("ERP plot", "Butterfly plot", "Topoplot", "Topoplot\ntimeseries", "ERP grid", "ERP image", "Channel image", "Parallel plot")

t <- list(n1, n2, n3, n4, n5, n6, n8, n7) 

create_table <- function(t){
  tmp <- t[[1]] %>% mutate(total = sum(n)) %>% slice(1:3) %>% mutate(type = plot_names[1]) %>% rename_with(.cols = 1, ~"names") %>% relocate(type, names )
  
  for (i in 2:8){
    tmp <- t[[i]]  %>% mutate(total = sum(n)) %>% slice(1:3) %>% 
      mutate(type = plot_names[i]) %>% rename_with(.cols = 1, ~"names") %>% relocate(type, names) %>% 
      rbind(tmp, .)
  }
  tmp <- tmp %>% 
    group_by( type) %>%
    dplyr::mutate(groupRow = 1:n()) %>%
    ungroup() %>% mutate(p = round(as.numeric(n)/as.numeric(total), 2) * 100) %>% 
    mutate(score = paste(p, total, sep = "% out of ")) %>% 
    dplyr::mutate(type = ifelse(groupRow == 1, as.character(type), "")) %>%
    dplyr::mutate(score = ifelse(groupRow == 1, as.character(score), paste(p, "%", sep = ""))) %>%
    select(-c(groupRow))
}



create_table(t) %>% data.frame() %>% 
  mutate(names = str_to_sentence(names)) %>% 
  mutate(names = str_replace(names, "Erp", "ERP")) %>% 
  mutate(names = str_replace(names, "erp", "ERP")) %>%
  dplyr::rename(`Plot types` = type,
         `Names given by respondents` = names,
         `Scores` =  score) %>% select(-n, -total, -p)  %>% kable()  %>% 
  kable_minimal(full_width = F,  html_font = "Source Sans Pro") %>% 
  row_spec(c(3, 6, 9, 12, 15, 18, 21), extra_css = "border-bottom: 1px dotted gray;")

```

```{r}
plots2 <- c("img/1.png", "img/filler.png", "img/filler.png", "img/2.png", "img/filler.png", "img/filler.png", "img/3.png","img/filler.png", "img/filler.png", "img/4.png", "img/filler.png", "img/filler.png", "img/5.png", "img/filler.png", "img/filler.png", "img/6.png", "img/filler.png", "img/filler.png", "img/7.png", "img/filler.png", "img/filler.png", "img/8.png", "img/filler.png")

tab1 <- create_table(t) %>% data.frame() %>% 
  mutate(names = str_to_sentence(names)) %>% 
  mutate(names = str_replace(names, "Erp", "ERP")) %>% 
  mutate(names = str_replace(names, "erp", "ERP")) %>% tibble::add_column(Plots = plots2, .before = "type") %>% 
  dplyr::rename(`Plot types` = type,
         `Names given by respondents` = names,
         `Scores` =  score) %>% select(-n, -total, -p) %>%  gt()  %>% 
  text_transform(
    locations = cells_body(columns = Plots),
    fn = function(x) {
      lapply(x, function(x) {
              html(paste(local_image(filename = x)))
      })
    }
  ) %>% opt_table_font(font = "Source Sans Pro") %>%  tab_options(table_body.hlines.color = "transparent") %>% 
  tab_options(data_row.padding = px(0.1), table.font.size = 14, container.padding.x = 1) %>% 
   
  tab_style(
    style = cell_borders(
      sides = c("bottom"),
      color = "gray",
      weight = px(1.5),
      style = "dotted"
    ),
    locations = cells_body(rows = c(3, 6, 9, 12, 15, 18, 21))) 
tab1
gtsave(tab1, "tab1.png")
 
```


## Struggles with plots

### stats 

```{r, message= FALSE, warning=FALSE}
stat_preproc <- function(vec){
  #N = 70
  tmp <- vec %>% filter(!is.na(.)) %>% 
    dplyr::rename(words = !!names(.)[1]) %>% mutate(words = tolower(words)) %>% 
    mutate(words = ifelse(nchar(words) < 3, paste(words, "baddd"), words)) %>% 
    mutate(check = 
    ifelse(grepl("\\b(baddd|idea|sure|confus|aware|do not|know|why|good|remember|unsure|confusing|mess|unclear|ugly|don't|useless|nan|clear)\\b", words), "bad", "good")) 
  return(tmp)
}

vec_named <- names(data[ , grepl( "How would you " , names(data))])
plot_names <- c("line", "butterfly", "topo", "topo_series", "erp_grid", "erp_img", "parallel", "channel_img")

na_table <- function(data, vec_named, plot_names){
    temp <- data.frame(plot_names)
    temp$n <- NA
    for (i in 1:8){
      n_part <- 
        data[vec_named[i]] %>%  stat_preproc(.) %>% #View()
      filter(check != "bad") %>%  
      dplyr::summarise(n = n())  
      temp$n[i] <- n_part$n
    }
    return(temp)
}

num_named <- na_table(data, vec_named, plot_names)

familiar <-  data[61:68] %>% rename_at(vars(colnames(.)), ~ plot_names) %>% 
  mutate_at(vars(plot_names), function(., na.rm = FALSE) (x = ifelse(.=="Yes", 1, 0))) %>%
  t() %>% rowSums(.) %>% data.frame(.) %>%  tibble::rownames_to_column(., "plot") %>% 
  rename_at(vars(colnames(.)), ~ c("plots", "recognized"))

vec_plotted <- names(data[ , grepl( "Have you ever plotted " , names(data))]) 

do_vec <- function(vec_plotted, data, plot_names){
  t1 <- table(data[vec_plotted[1]])
  for (i in 2:length(vec_plotted)) {
    t <- table(data[vec_plotted[i]])
    t1 <- rbind(t1, t)
  }
  rownames(t1) <- plot_names 
  return(t1)
}

tab <- do_vec(vec_plotted, data, plot_names) %>%  data.frame() %>% tibble::rownames_to_column(., "plots") %>%  
  gather(., type, plotted, `N.A`:`Yes`, factor_key=TRUE) %>% 
  filter(type == "Yes") %>% dplyr::select(-type) 

named <- num_named %>% dplyr::rename(named = n, plots = plot_names)  

mem_tab <-  familiar %>% 
   rename_at(vars(colnames(.)), ~ c("plots", "recognized")) %>%
  left_join(., named)  %>% left_join(., tab)  
mem_tab

```

### struggles

```{r}
vec <- names(data[ , grepl( ".*Which parts of*." , names(data))])
#which(names(data) %in% vec)
```

```{r, warning=FALSE}
word_preproc_tool_2 <- function(data, N, lim){
  #lim = 10
  tmp <- data %>% dplyr::select(N, N+1, N+2) %>% dplyr::rename(soft = !!names(.)[1], parts = !!names(.)[2], new_feature = !!names(.)[3]) %>% 
    filter(!is.na(soft)) %>% 
    mutate_at(vars(colnames(.)), funs(tolower(.))) %>% 
    mutate(soft = str_replace(soft, 'own', "custom"), 
           soft = str_replace(soft, '(matlab)', "matlab"), 
           soft = case_when(
      str_detect(soft, 'brain vision') ~ "brain vision analyser",
      #str_detect(soft, 'matlab|bar.m|boundedline') ~ "custom matlab",
      str_detect(soft, 'mne') ~ "mne",
      TRUE ~ as.character(soft)
    ), 
    parts = case_when(
      str_detect(parts, 'none|n/a|nope|na|idk|nothing|sure|know|can\'t|don\'t|easy') ~ "-",
      TRUE ~ as.character(parts)
    ),
    new_feature = case_when(
      str_detect(new_feature, 'none|n/a|nope|na|idk|nothing|sure|know|can\'t|don\'t') ~ "-",
      TRUE ~ as.character(new_feature)
    )) %>% 
  
    filter_at(vars(parts, new_feature), all_vars(!is.na(.))) %>% mutate(n = lengths(gregexpr("\\W+", soft)) + 1) %>% 
    filter(parts != "-" | new_feature != "-", n < lim) %>%  dplyr::select(-4) %>% arrange(soft)
  return(tmp)
}
```

#### 1

```{r, warning=FALSE}
struggle1 <- word_preproc_tool_2(data, 71, 10) 
separated_row <- separate_rows(struggle1[98, ], parts, sep = ",|\\.") %>% dplyr::select(soft, parts)

tmp <- struggle1 %>% filter( parts != "-") %>% dplyr::select(soft, parts) %>% 
  filter(!row_number() %in% c(2, 11, 40, 41, 69, 78, 83, 87, 89, 91))  %>% 
  separate_rows(parts, sep = "2\\)", convert = FALSE) %>% 
  separate_rows(parts, sep = "\\\r\\\n", convert = FALSE) %>%  rbind(., separated_row) %>%
  mutate(problems = case_when(
      grepl("\\b(ci|se|sem|errorbar(s)?|sme|sd|uncertainty|error(s)?|confidence|variance|deviation(s)?|shading|shaded|bars|transparency)\\b", parts) == TRUE ~ "uncertainty", 
      grepl("\\b(axes|lable(s)?|label(s)?|legend|ticks)\\b", parts) == TRUE ~ "plot components\n(axes, lables, legend)", 
      grepl("\\b(color(s)?|colour(s)?|proportion(s)?|publication|scal(e|ing))\\b", parts) == TRUE ~ "styling and color", 
      grepl("\\b(preprocessing|extracting|datatype)\\b", parts) == TRUE ~ "preprocessing", 
      grepl("\\b(syncronisation|organizing|groups)\\b", parts) == TRUE ~ "subplotting", 
      grepl("\\b(mean|significan(t|ce)|permutations|combine)\\b", parts) == TRUE ~ "statistics", 
      )) %>% filter(nchar(parts) != 0) %>% filter(!is.na(problems)) #%>% View()

n_rest <- mem_tab %>% filter(plots == "line") %>% select(plotted)  - nrow(tmp)


tmp1 <- tmp  %>% group_by(problems) %>%
      dplyr::summarise(n = n()) %>% 
      rbind(c("no complains", as.numeric(n_rest$plotted))) %>% 
      mutate(n = as.numeric(n)) %>% 
      mutate(total = sum(n)) 

problem1 <- tmp1 %>%  mutate(name = "ERP plot")

tmp1
```


#### 2

```{r, warning=FALSE}
struggle2 <- word_preproc_tool_2(data, 82, 10) 
#separated_row <- separate_rows(struggle1[98, ], parts, sep = ",|\\.") %>% dplyr::select(parts)

tmp <- struggle2 %>% filter( parts != "-") %>% dplyr::select(parts) %>%
  filter(!row_number() %in% c(18, 31))  %>% 
  #separate_rows(parts, sep = "2\\)", convert = FALSE) %>% 
  #separate_rows(parts, sep = "\\\r\\\n", convert = FALSE) %>%  rbind(., separated_row) %>%
  mutate(problems = case_when(
      grepl("\\b(ci|se|sem|errorbar(s)?|sme|sd|uncertainty|error(s)?|confidence|variance|deviation(s)?|shading|shaded|bars|transparency)\\b", parts) == TRUE ~ "uncertainty", 
      grepl("\\b(ax(is|es)?|lable(s)?|label(s)?|legend|ticks)\\b", parts) == TRUE ~ "plot components\n(axes, lables, legend)", 
      grepl("\\b(color(s|ing)?|colour(s)?|proportion(s)?|publication|neg|scal(e|ing))\\b", parts) == TRUE ~ "styling and color", 
      grepl("\\btopo\\w*", parts) == TRUE ~ "adding topography", 
      grepl("\\b(channel(s)?|electrodes(s)?|interpretable|read|remembering)\\b", parts) == TRUE ~ "channel selection"
      )) %>% filter(nchar(parts) != 0) %>% filter(!is.na(problems)) 

n_rest <- mem_tab %>% filter(plots == "butterfly") %>% select(plotted)  - nrow(tmp)

tmp2 <- tmp %>% group_by(problems) %>%
      dplyr::summarise(n = n()) %>% 
      rbind(c("no complains", as.numeric(n_rest$plotted))) %>% 
      mutate(n = as.numeric(n)) %>% 
      mutate(total = sum(n)) 

problem2 <- tmp2  %>% mutate(name = "Butterfly plot")

tmp2 
```

#### 3

```{r, warning=FALSE}
struggle3 <- word_preproc_tool_2(data, 87, 10) 
#separated_row <- separate_rows(struggle1[98, ], parts, sep = ",|\\.") %>% dplyr::select(parts)

tmp <- struggle3 %>% filter( parts != "-") %>% dplyr::select(parts) %>% 
  filter(!row_number() %in% c(5, 7, 16, 18, 43, 50))  %>% 
  separate_rows(parts, sep = ";", convert = FALSE) %>% filter(nchar(parts) != 0) %>%  
  filter(!row_number() %in% c(59))  %>% 
  #separate_rows(parts, sep = "\\\r\\\n", convert = FALSE) %>%  rbind(., separated_row) %>%
  mutate(problems = case_when(
    grepl("\\b(head|headshape|montage|topographies)\\b", parts) == TRUE ~ "head shape and montage",
    grepl("\\b(time|threshold)\\b", parts) == TRUE ~ "time selection",
      grepl("\\b(ci|se|sem|errorbar(s)?|sme|sd|uncertainty|error(s)?|confidence|variance|deviation(s)?|shading|shaded|bars|transparency)\\b", parts) == TRUE ~ "uncertainty",
      grepl("\\b(scal(e|ing|es))\\b", parts) == TRUE ~ "scaling", 
      grepl("\\b(interpolat(e|ion)?|edges)\\b", parts) == TRUE ~ "interpolation",
      grepl("\\b(color(s|ing|bar|map)?|colour(s)?|proportion(s)?|publication|limits|neg)\\b", parts) == TRUE ~ "styling and color", 
      grepl("\\b(channel(s)?|electrode(s)?|sensors|elec)\\b", parts) == TRUE ~ "channel selection",
      
      grepl("\\b(ax(is|es)?|lable(s)?|label(s|ing)?|legend|ticks|features|layout)\\b", parts) == TRUE ~ "plot components\n(axes, lables, legend)", 
      grepl("\\b(mean|significan(t|ce)|permutations|p-value(s)?|smoothing|statistical|stats)\\b", parts) == TRUE ~ "statistics",
      )) %>% #View() 

filter(nchar(parts) != 0) %>% filter(!is.na(problems)) 

n_rest <- mem_tab %>% filter(plots == "topo") %>% select(plotted)  - nrow(tmp)

tmp3 <- tmp %>% group_by(problems) %>%
      dplyr::summarise(n = n()) %>% 
      rbind(c("no complains", as.numeric(n_rest$plotted))) %>% 
      mutate(n = as.numeric(n)) %>%       
  mutate(total = sum(n)) 

problem3 <- tmp3 %>% mutate(name = "Topoplot")

tmp3


```


#### 4

```{r, warning=FALSE}
struggle4 <- word_preproc_tool_2(data, 92, 10) 
#separated_row <- separate_rows(struggle1[98, ], parts, sep = ",|\\.") %>% dplyr::select(parts)

tmp <- struggle4 %>% filter( parts != "-") %>% dplyr::select(parts) %>% 
  filter(!grepl("\\b(no|okay|certain|see|same as|\"\"|reaching)\\b", parts)) %>% #View()
  filter(!row_number() %in% c(17, 51, 12 ))  %>% 
  separate_rows(parts, sep = ";", convert = FALSE) %>% 
#filter(!row_number() %in% c(59))  %>% 
  #separate_rows(parts, sep = "\\\r\\\n", convert = FALSE) %>%  rbind(., separated_row) %>%
  mutate(problems = case_when(
    grepl("\\b(head|headshape|montage|topographies|topoplots|shape)\\b", parts) == TRUE ~ "head shape and montage",
    grepl("\\b(time(s|course|points)?|threshold)\\b", parts) == TRUE ~ "time selection",
      grepl("\\b(ci|se|sem|errorbar(s)?|sme|sd|uncertainty|error(s)?|confidence|variance|deviation(s)?|shading|shaded|bars|transparency)\\b", parts) == TRUE ~ "uncertainty",
      grepl("\\b(channel(s)?|electrode(s)?|sensors|elec)\\b", parts) == TRUE ~ "channel selection",
      grepl("\\b(color(s|ing|bar|map|scale)?|colour(s)?|proportion(s)?|publication|limits|neg|scal(e|ing|es))\\b", parts) == TRUE ~ "styling and color", 
      grepl("\\b(ax(is|es)?|lable(s)?|label(s|ing)?|legend|ticks|features|markers|layout|specifications)\\b", parts) == TRUE ~ "plot components\n(axes, lables, legend)", 
       grepl("\\b(legible|readable|visible|small|datatype|shape|montage|subplots|size(s)?|resizing|arrange|channel(s)?|electrode(s)?|sensors)|scal(e|ing|es)|references\\b", parts) == TRUE ~ "legibility and scaling",
      grepl("\\b(mean|significan(t|ce)|permutations|p-value(s)?|smoothing|statistical|stats|t-stat)\\b", parts) == TRUE ~ "statistics",
      grepl("\\b(interpolat(e|ion)?|edges)\\b", parts) == TRUE ~ "interpolation",
      TRUE ~ '_other'
      )) %>% filter(nchar(parts) != 0) %>% filter(!is.na(problems)) #%>%   filter(problems =="_other") %>% View()

n_rest <- mem_tab %>% filter(plots == "topo_series") %>% select(plotted)  - nrow(tmp)

tmp4 <- tmp %>% group_by(problems) %>%
      dplyr::summarise(n = n()) %>% 
      rbind(c("no complains", as.numeric(n_rest$plotted))) %>% 
      mutate(n = as.numeric(n)) %>% 
      mutate(total = sum(n)) 
problem4 <- tmp4  %>% mutate(name = "Topoplot timeseries")
tmp4

```

#### 5

```{r, warning=FALSE}
struggle5 <- word_preproc_tool_2(data, 99, 10) 
#separated_row <- separate_rows(struggle1[98, ], parts, sep = ",|\\.") %>% dplyr::select(parts)

tmp <- struggle5 %>% filter( parts != "-") %>% dplyr::select(parts) %>% #View()
  filter(!grepl("\\b(_|reaching)\\b", parts)) %>%
  filter(!row_number() %in% c(33 ))  %>% 
  separate_rows(parts, sep = ";", convert = FALSE) %>% #View()
#filter(!row_number() %in% c(59))  %>% 
  #separate_rows(parts, sep = "\\\r\\\n", convert = FALSE) %>%  rbind(., separated_row) %>%
  mutate(problems = case_when(
    grepl("\\b(selecting|marking|spotting)\\b", parts) == TRUE ~ "channel selection\n(differentiation, identification)",
    grepl("\\b(legible|readable|visible|small|datatype|shape|montage|subplots|size(s)?|larger|dimensions|channel(s)?|electrode(s)?|sensors)|scal(e|ing|es)|references\\b", parts) == TRUE ~ "legibility and scaling",
      grepl("\\b(ci|se|sem|errorbar(s)?|sme|sd|uncertainty|error(s)?|confidence|variance|deviation(s)?|shading|shaded|bars|transparency)\\b", parts) == TRUE ~ "uncertainty",
      grepl("\\b(color(s|ing|bar|map)?|colour(s)?|proportion(s)?|publication|limits|quality|scal(e|ing|es))\\b", parts) == TRUE ~ "styling and color", 
      grepl("\\b(ax(is|es)?|lable(s)?|label(s|ing)?|legend|ticks|edit|features|markers|layout|specifications)\\b", parts) == TRUE ~ "plot components\n(axes, lables, legend)", 
      grepl("\\b(preprocessing|extracting|masks)\\b", parts) == TRUE ~ "preprocessing", 
    
      TRUE ~ '_other'
      )) %>% filter(nchar(parts) != 0) %>% filter(!is.na(problems)) #%>%   filter(problems =="legibility and scaling") %>% View()

n_rest <- mem_tab %>% filter(plots == "erp_grid") %>% select(plotted)  - nrow(tmp)

tmp5 <- tmp %>% group_by(problems) %>%
      dplyr::summarise(n = n()) %>% 
      rbind(c("no complains", as.numeric(n_rest$plotted))) %>% 
      mutate(n = as.numeric(n)) %>% 
      mutate(total = sum(n)) 

problem5 <- tmp5 %>% mutate(name = "ERP grid")
tmp5

```

#### 6

```{r, warning=FALSE}
struggle6 <- word_preproc_tool_2(data, 104, 10) 
#separated_row <- separate_rows(struggle1[98, ], parts, sep = ",|\\.") %>% dplyr::select(parts)

tmp <- struggle6 %>% filter( parts != "-") %>% dplyr::select(parts) %>% 
  filter(!grepl("\\b(x|ok|no)\\b", parts)) %>% 
 # filter(!row_number() %in% c(33 ))  %>% 
  separate_rows(parts, sep = ";", convert = FALSE) %>% #View()
#filter(!row_number() %in% c(59))  %>% 
  #separate_rows(parts, sep = "\\\r\\\n", convert = FALSE) %>%  rbind(., separated_row) %>%
  mutate(problems = case_when(
    grepl("\\b(sort(ing)?|max|correspondance)\\b", parts) == TRUE ~ "sorting", 
    grepl("\\b(smoothing)\\b", parts) == TRUE ~ "smoothing", 
    grepl("\\b(epochs|time)\\b", parts) == TRUE ~ "defining epochs", 
    grepl("\\b(colo(r|ur)|paper)\\b", parts) == TRUE ~ "styling and color", 
    
      TRUE ~ '_other'
      )) %>% filter(nchar(parts) != 0) %>% filter(!is.na(problems)) #%>%   filter(problems =="defining epochs") %>% View()

n_rest <- mem_tab %>% filter(plots == "erp_img") %>% select(plotted)  - nrow(tmp)

tmp6 <- tmp %>% group_by(problems) %>%
      dplyr::summarise(n = n()) %>% 
      rbind(c("no complains", as.numeric(n_rest$plotted))) %>% 
      mutate(n = as.numeric(n)) %>% 
            mutate(total = sum(n)) 

problem6 <- tmp6 %>% mutate(name = "ERP image")
tmp6
```

#### 8

```{r, warning=FALSE}
struggle8 <- word_preproc_tool_2(data, 114, 10) 
#separated_row <- separate_rows(struggle1[98, ], parts, sep = ",|\\.") %>% dplyr::select(parts)

tmp <- struggle8 %>% filter( parts != "-") %>% dplyr::select(parts) %>% 
  filter(!grepl("\\b(n|x|ok|dont)\\b", parts)) %>% #View()
 # filter(!row_number() %in% c(33 ))  %>% 
  #separate_rows(parts, sep = ";", convert = FALSE) %>% #View()
#filter(!row_number() %in% c(59))  %>% 
  #separate_rows(parts, sep = "\\\r\\\n", convert = FALSE) %>%  rbind(., separated_row) %>%
  mutate(problems = case_when(
    grepl("\\b(sort(ing)?|order(ing)?|organisation)\\b", parts) == TRUE ~ "order and sorting", 
    grepl("\\b(scale|visability|interpreting|range)\\b", parts) == TRUE ~ "legibility and scaling", 
    grepl("\\b(color(bar)?|paper)\\b", parts) == TRUE ~ "styling and color", 
    
      TRUE ~ '_other'
      )) %>% filter(nchar(parts) != 0) %>% filter(!is.na(problems))# %>%   filter(problems =="_other") %>% View()

n_rest <- mem_tab %>% filter(plots == "channel_img") %>% select(plotted)  - nrow(tmp)

tmp8 <- tmp %>% group_by(problems) %>%
      dplyr::summarise(n = n()) %>% 
      rbind(c("no complains", as.numeric(n_rest$plotted))) %>% 
      mutate(n = as.numeric(n)) %>% 
      mutate(total = sum(n)) 
problem8 <- tmp8 %>% mutate(name = "Channel image")

tmp8
```


### The most problematic plot

```{r}

rbind(problem1, problem2, problem3, problem4, problem5, problem6, problem8) %>%
  group_by(name) %>%  mutate(index = match(name, unique(name))) %>% filter(problems == "no complains") %>%
  mutate(percent1 = 100 - (round(n / total, 2) * 100)) %>% 
  ggplot(., aes(y = reorder(name, percent1), x = percent1)) +
  geom_col(fill ="lightblue1", colour ="dodgerblue3") + 
  geom_text(aes(label = paste0(percent1, "%"), y = name, x = percent1),
            position = position_stack(vjust = 0.5), color = "black") +
  labs(x = "Percent of complains", y  = "") +
  theme_classic() +
  theme(axis.text = element_text(size = 12), legend.position = "none")
```
### Combined
```{r}
prob_comb <- rbind(problem1, problem2, problem3, problem4, problem5, problem6, problem8) %>%
  group_by(name) %>%  mutate(index = match(name, unique(name)))  %>% filter(problems != "no complains") %>% 
  arrange(desc(n)) %>% slice(1:3) %>% 
  arrange(index) %>%  dplyr::select(name, problems, n, total) %>%  
  mutate(name = str_to_sentence(name)) %>% 
  mutate(name = str_replace(name, "Erp", "ERP")) %>% 
  mutate(name = str_replace(name, "erp", "ERP")) %>%  
  group_by(name) %>%
  dplyr::mutate(groupRow = 1:n()) %>%
  ungroup() %>%
  mutate(p = round(as.numeric(n)/as.numeric(total), 2) * 100) %>% 
  group_by(name) %>% mutate(mx = max(p)) %>% 
  arrange(desc(mx), desc(p)) %>% 
  mutate(score = paste(p, total, sep = "% out of ")) %>% 
  dplyr::mutate(name = ifelse(groupRow == 1, as.character(name), "")) %>%
  dplyr::mutate(score = ifelse(groupRow == 1, as.character(score), paste(p, "%", sep = ""))) %>%
  select(-c(groupRow, n, total, p, mx)) 

```

```{r}
library(kableExtra)
prob_comb %>% 
  kable(escape = F, booktabs = T, col.names = c("Plot name", "The main problem", "Scores"))   %>% 
  kable_minimal(full_width = F,  html_font = "Source Sans Pro") %>% 
  row_spec(c(3, 6, 9, 12, 15, 18), extra_css = "border-bottom: 1px dotted gray;")
```

```{r}
plots3 <- c("img/1.png", "img/filler.png", "img/filler.png", "img/5.png", "img/filler.png", "img/filler.png", "img/4.png","img/filler.png", "img/filler.png", "img/7.png", "img/filler.png", "img/filler.png", "img/2.png", "img/filler.png", "img/filler.png", "img/6.png", "img/filler.png", "img/filler.png", "img/3.png", "img/filler.png", "img/filler.png")

tab2 <- prob_comb %>% tibble::add_column(Plots = plots3, .before = "name") %>% dplyr::rename(`Plot name` = name,
         `The main problem` = problems,
         `Scores` =  score) %>% ungroup() %>% gt()  %>% 
  text_transform(
    locations = cells_body(columns = Plots),
    fn = function(x) {
      lapply(x, function(x) {
              html(paste(local_image(filename = x)))
      })
    }
  ) %>% opt_table_font(font = "Source Sans Pro") %>%  tab_options(table_body.hlines.color = "transparent") %>% 
  tab_options(data_row.padding = px(0.8)) %>% 
  tab_style(
    style = cell_borders(
      sides = c("bottom"),
      color = "gray",
      weight = px(1.5),
      style = "dotted"
    ),
    locations = cells_body(rows = c(3, 6, 9, 12, 15, 18)))
tab2
#gtsave(tab2, "tab2.png")

```


## New features

#### 1

```{r, warning=FALSE}

tmp <- struggle1 %>% filter( new_feature != "-") %>% dplyr::select(new_feature) %>%
  filter(!grepl("\\b(\\.|\\/|see)\\b", new_feature)) %>%  
  filter(!row_number() %in% c(13, 18, 20  ))  %>% 
  separate_rows(new_feature, sep = ";", convert = FALSE) %>% 
#filter(!row_number() %in% c(59))  %>% 
  separate_rows(new_feature, sep = "\\\r\\\n", convert = FALSE) %>% 
  mutate(group = case_when(
    grepl("\\bsignif\\w*", new_feature) == TRUE ~ "adding significance", 
    grepl("\\bstat\\w*", new_feature) == TRUE ~ "adding statistics", 
    grepl("\\btopo\\w*", new_feature) == TRUE ~ "adding topoplot", 
    grepl("\\b(custom\\w*|details|annotations|font|labels|color|colours|thicker)", new_feature) == TRUE ~ "customization (color, labels)", 
    grepl("\\b(electrode|click|control|interact\\w*|gui|select\\w*)", new_feature) == TRUE ~ "interactivity and channel selection", 
    grepl("\\b(highlight|shadow|window)", new_feature) == TRUE ~ "area highlighting", 
    grepl("\\b(ci|ribbons|se|ses|sem|errorbar(s)?|sme|sd|uncertainty|error(s)?|confidence|variance|deviation(s)?|shading|shaded|bars|transparency)\\b", new_feature) == TRUE ~ "uncertainty", 
    
      TRUE ~ '_other'
      )) %>% filter(nchar(new_feature) != 0) #%>% View()

#n_rest <- mem_tab[2, 3] - nrow(tmp)

tmp1 <- tmp %>% group_by(group) %>%
      dplyr::summarise(n = n()) %>% 
     # rbind(c("no complains", as.numeric(n_rest))) %>% 
      mutate(n = as.numeric(n)) %>% 
      mutate(percent = round(n / sum(n), 3) * 100, percent1 = round(n / sum(n), 2) * 100) 


tmp1 %>% 
  arrange(desc(n)) %>% 
  kable(escape = F, booktabs = T) %>% kable_styling("striped", position = "center",) %>% 
  kable_classic(full_width = F, html_font = "Arial")

 # words = ifelse(nchar(words)==0, NA, words),
#write.xlsx(tmp, "data/struggles.xlsx", sheetName = "line plot", col.names = TRUE, row.names = TRUE, append = FALSE)

# problems: n of problems is higher than number of rows 

```

#### 2

```{r, warning=FALSE}

tmp <- struggle2 %>% filter( new_feature != "-") %>% dplyr::select(new_feature) %>% #View()
  filter(!grepl("\\b(see|not|useful)\\b", new_feature)) %>%  
  #filter(!row_number() %in% c(13, 18, 20  ))  %>% 
  #separate_rows(new_feature, sep = ";", convert = FALSE) %>% 
#filter(!row_number() %in% c(59))  %>% 
  separate_rows(new_feature, sep = "\\\r\\\n", convert = FALSE) %>% 
  mutate(group = case_when(
    grepl("\\bsignif\\w*", new_feature) == TRUE ~ "adding significance", 
    grepl("\\b(stat\\w*|average|mean)", new_feature) == TRUE ~ "adding statistics", 
    grepl("\\btopo\\w*", new_feature) == TRUE ~ "adding topoplot", 
    grepl("\\b(custom\\w*|details|annotations|opacity|font|labels|color|colour(s)?|thicker)", new_feature) == TRUE ~ "customization (color, labels)", 
    grepl("\\b(manipulating|highlight|graying|click|control|interact\\w*|gui|select\\w*)", new_feature) == TRUE ~ "interactivity and channel selection", 
    grepl("\\b(ci|ribbons|se|ses|sem|errorbar(s)?|sme|sd|uncertainty|error(s)?|confidence|variance|deviation(s)?|shading|shaded|bars|transparency)\\b", new_feature) == TRUE ~ "uncertainty", 
    
      TRUE ~ '_other'
      )) %>% filter(nchar(new_feature) != 0) #%>% View()

tmp1 <- tmp %>% group_by(group) %>%
      dplyr::summarise(n = n()) %>% 
     # rbind(c("no complains", as.numeric(n_rest))) %>% 
      mutate(n = as.numeric(n)) %>% 
      mutate(percent = round(n / sum(n), 3) * 100, percent1 = round(n / sum(n), 2) * 100) 


tmp1 %>% 
  arrange(desc(n)) %>% 
  kable(escape = F, booktabs = T) %>% kable_styling("striped", position = "center",) %>% 
  kable_classic(full_width = F, html_font = "Arial")

```

#### 3

```{r, warning=FALSE}

tmp <- struggle3 %>% filter( new_feature != "-") %>% dplyr::select(new_feature) %>% 
  filter(!grepl("\\b(no|\\/|above|good|balanced)\\b", new_feature)) %>%  #View()
  #filter(!row_number() %in% c(13, 18, 20  ))  %>% 
  #separate_rows(new_feature, sep = ";", convert = FALSE) %>% 
#filter(!row_number() %in% c(59))  %>% 
  separate_rows(new_feature, sep = "\\\r\\\n", convert = FALSE) %>% 
  mutate(group = case_when(
    grepl("\\bsignif\\w*", new_feature) == TRUE ~ "adding significance",
    grepl("\\b(3d)\\b", new_feature) == TRUE ~ "3d", 
    grepl("\\b(stat\\w*|average|mean)\\b", new_feature) == TRUE ~ "adding statistics", 
    grepl("\\b(interpolat\\w*|extrapolat\\w*)\\b", new_feature) == TRUE ~ "interpolation and extrapolation", 
    grepl("\\btopo\\w*", new_feature) == TRUE ~ "adding topoplot", 
    grepl("\\b(custom\\w*|details|annotations|opacity|font|labels|color(s|map|maps|bar)?|colour(s)?|thicker)\\b", new_feature) == TRUE ~ "customization (color, labels)", 
    grepl("\\b(anomatiom|slider|scrolling|gif|manipulating|hightlight|highlight|graying|click|control|interact\\w*|gui|select\\w*)", new_feature) == TRUE ~ "interactivity and channel selection", 
    grepl("\\b(ci|ribbons|se|ses|sem|errorbar(s)?|sme|sd|uncertainty|error(s)?|confidence|variance|deviation(s)?|shading|shaded|bars|transparency)\\b", new_feature) == TRUE ~ "uncertainty", 
     grepl("\\b(shape(s)?|circle|head)\\b", new_feature) == TRUE ~ "head shape", 
      TRUE ~ '_other'
      )) %>% filter(nchar(new_feature) != 0)# %>% View()


tmp1 <- tmp %>% group_by(group) %>%
      dplyr::summarise(n = n()) %>% 
     # rbind(c("no complains", as.numeric(n_rest))) %>% 
      mutate(n = as.numeric(n)) %>% 
      mutate(percent = round(n / sum(n), 3) * 100, percent1 = round(n / sum(n), 2) * 100) 


tmp1 %>% 
  arrange(desc(n)) %>% 
  kable(escape = F, booktabs = T) %>% kable_styling("striped", position = "center",) %>% 
  kable_classic(full_width = F, html_font = "Arial")

```

## Feedback

```{r}
feed <- data[120] %>% dplyr::rename(feed = !!names(.)[1]) %>%  filter(!is.na(feed), feed != "-") #%>% View()
feed  %>%
  filter(!row_number() %in% c(3, 14, 17, 32, 37, 41))# just appreciation
```


